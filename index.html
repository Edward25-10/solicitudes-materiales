<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Solicitud de Materiales de Oficina</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>[x-cloak]{display:none}</style>
</head>
<body class="bg-gray-100 py-8 px-4"> <div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-xl"> <h1 class="text-2xl font-bold text-indigo-700 mb-6 text-center md:text-left">Solicitud de Materiales de Oficina</h1>

  <form id="formSolicitud" class="space-y-8">
    <fieldset class="border border-gray-300 p-4 rounded-lg">
      <legend class="text-lg font-semibold text-gray-700 px-2">Información General</legend>
      <div class="grid md:grid-cols-2 gap-6 mt-4">
        <div>
          <label for="idSolicitud" class="block mb-1 text-sm font-medium text-gray-700">ID Solicitud (Automático)</label>
          <input id="idSolicitud" name="idSolicitud" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label for="fechaSolicitud" class="block mb-1 text-sm font-medium text-gray-700">Fecha de Solicitud</label>
          <input id="fechaSolicitud" name="fechaSolicitud" type="date" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label for="jefeEquipo" class="block mb-1 text-sm font-medium text-gray-700">Nombre del Jefe/a de Equipo Solicitante</label>
          <input id="jefeEquipo" name="jefeEquipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ej: Carla Rojas">
        </div>
        <div>
          <label for="departamento" class="block mb-1 text-sm font-medium text-gray-700">Departamento/Unidad</label>
          <select id="departamento" name="departamento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="">— Seleccionar Departamento —</option>
            <option value="Administración y Finanzas">Administración y Finanzas</option>
            <option value="Comunicaciones">Comunicaciones</option>
            <option value="Dirección Nacional">Dirección Nacional</option>
            <option value="Unidad de Aseo">Unidad de Aseo</option>
            <option value="Unidad de Género">Unidad de Género</option>
            <option value="Otro">Otro (Especificar en Justificación)</option>
          </select>
        </div>
        <div>
          <label for="centroCosto" class="block mb-1 text-sm font-medium text-gray-700">Centro de Costo (Opcional)</label>
          <input id="centroCosto" name="centroCosto" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ej: CC-PROY-01">
        </div>
        <div>
          <label for="emailSolicitante" class="block mb-1 text-sm font-medium text-gray-700">Email de Contacto</label>
          <input id="emailSolicitante" name="emailSolicitante" type="email" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ejemplo@dominio.cl">
        </div>
      </div>
    </fieldset>

    <fieldset class="border border-gray-300 p-4 rounded-lg">
      <legend class="text-lg font-semibold text-gray-700 px-2">Artículos Solicitados</legend>
      <div class="overflow-x-auto mt-4"> <table id="tablaItems" class="w-full text-sm border-t border-gray-200">
          <thead class="bg-gray-100">
            <tr class="text-gray-600">
              <th class="p-2 text-center font-medium">#</th>
              <th class="p-2 text-left font-medium">Descripción del Artículo</th>
              <th class="p-2 text-center font-medium">Cantidad</th>
              <th class="p-2 text-left font-medium">Unidad</th>
              <th class="p-2 font-medium">Acción</th>
            </tr>
          </thead>
          <tbody>
            </tbody>
        </table>
      </div>
      <button type="button" id="addItemBtn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
        + Agregar Artículo
      </button>
    </fieldset>

    <fieldset class="border border-gray-300 p-4 rounded-lg">
      <legend class="text-lg font-semibold text-gray-700 px-2">Justificación</legend>
      <div class="mt-2">
        <label for="justificacion" class="block mb-1 text-sm font-medium text-gray-700">Motivo de la solicitud y uso de los materiales:</label>
        <textarea id="justificacion" name="justificacion" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Describa brevemente..."></textarea>
      </div>
    </fieldset>

    <details class="border border-gray-300 rounded">
      <summary class="cursor-pointer font-semibold text-gray-700 p-4 hover:bg-gray-50 rounded-t">
        Campos de Control Interno (Uso Opcional por Administración)
      </summary>
      <div class="grid md:grid-cols-2 gap-6 p-4 border-t border-gray-300">
        <div>
          <label for="nombreJefeAprueba" class="block mb-1 text-sm font-medium text-gray-700">Nombre Jefe/a que Aprueba</label>
          <input id="nombreJefeAprueba" name="nombreJefeAprueba" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label for="fechaAprobacion" class="block mb-1 text-sm font-medium text-gray-700">Fecha de Aprobación</label>
          <input id="fechaAprobacion" name="fechaAprobacion" type="date" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label for="estadoSolicitud" class="block mb-1 text-sm font-medium text-gray-700">Estado de la Solicitud</label>
          <select id="estadoSolicitud" name="estadoSolicitud" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="Pendiente">Pendiente</option>
            <option value="Aprobada">Aprobada</option>
            <option value="Rechazada">Rechazada</option>
            <option value="Entregada Parcialmente">Entregada Parcialmente</option>
            <option value="Entregada Completamente">Entregada Completamente</option>
          </select>
        </div>
        <div>
          <label for="responsableEntrega" class="block mb-1 text-sm font-medium text-gray-700">Responsable de Entrega</label>
          <input id="responsableEntrega" name="responsableEntrega" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div class="md:col-span-2">
          <label for="observaciones" class="block mb-1 text-sm font-medium text-gray-700">Observaciones (Control Interno)</label>
          <textarea id="observaciones" name="observaciones" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
        </div>
      </div>
    </details>

    <div id="feedbackMessage" class="text-sm mt-4 p-3 rounded-md" role="alert" aria-live="assertive"></div>
    <div class="flex flex-col sm:flex-row gap-4 justify-end pt-4 border-t border-gray-200">
      <button type="button" onclick="window.print()" class="w-full sm:w-auto px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">Imprimir</button>
      <button type="submit" id="submitButton" class="w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors">
        Enviar Solicitud a Google Sheets
      </button>
    </div>
  </form>
</div>

<script>
  // ------------------------------------------------------------------------------------
  // !!!!! IMPORTANTE !!!!! ¡ATENCIÓN AQUÍ! !!!!! IMPORTANTE !!!!!
  // ------------------------------------------------------------------------------------
  // REEMPLAZA LA SIGUIENTE LÍNEA CON LA URL EXACTA DE TU APLICACIÓN WEB DE GOOGLE APPS SCRIPT.
  // ESTA URL LA OBTIENES DESPUÉS DE HACER CLIC EN "IMPLEMENTAR" > "NUEVA IMPLEMENTACIÓN" (O "GESTIONAR IMPLEMENTACIONES")
  // EN EL EDITOR DE GOOGLE APPS SCRIPT.
  // Ejemplo: const URL_SCRIPT = 'https://script.google.com/macros/s/TU_ID_UNICO_AQUI/exec';
  //
  const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbxgWa9-DAur82RwW8ZBzRqZGeYVEEfWl_BTmEL_dGgQZotD5LBg_neG0fOrcuFo2EEH/exec'; // ⇦ ¡REEMPLAZA ESTO!
  // ------------------------------------------------------------------------------------

  const form = document.getElementById('formSolicitud');
  const tbodyItems = document.querySelector('#tablaItems tbody');
  const feedbackDiv = document.getElementById('feedbackMessage');
  const submitButton = document.getElementById('submitButton');

  // --- Funciones de utilidad ---
  const notify = (message, isSuccess = true) => {
    feedbackDiv.textContent = message;
    feedbackDiv.className = `text-sm mt-4 p-3 rounded-md ${isSuccess ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-red-100 text-red-700 border border-red-300'}`;
    if (!isSuccess) {
        console.error("Error notificado:", message);
    }
  };

  const generateRowHTML = (itemNumber) => {
    return `
      <tr class="item-row border-b border-gray-200">
        <td class="p-2 text-center item-number">${itemNumber}</td>
        <td class="p-2"><input name="itemDescripcion" class="w-full border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="Ej: Resma Oficio" required></td>
        <td class="p-2"><input name="itemCantidad" type="number" min="1" class="w-20 border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="1" required></td>
        <td class="p-2">
          <select name="itemUnidad" class="w-full border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500" required>
            <option value="">Unidad</option>
            <option value="Unidad">Unidad</option>
            <option value="Caja">Caja</option>
            <option value="Paquete">Paquete</option>
            <option value="Resma">Resma</option>
            <option value="Docena">Docena</option>
            <option value="Otro">Otro</option>
          </select>
        </td>
        <td class="p-2 text-center">
          <button type="button" onclick="this.closest('tr').remove(); renumberItemRows();" class="text-red-500 hover:text-red-700" aria-label="Eliminar artículo">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
          </button>
        </td>
      </tr>`;
  };

  const renumberItemRows = () => {
    const rows = tbodyItems.querySelectorAll('.item-row');
    rows.forEach((row, index) => {
      row.querySelector('.item-number').textContent = index + 1;
    });
  };

  const addItemRow = () => {
    const itemCount = tbodyItems.rows.length + 1;
    tbodyItems.insertAdjacentHTML('beforeend', generateRowHTML(itemCount));
  };

  const generateSolicitudID = () => {
    const d = new Date();
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const randomSuffix = Math.floor(Math.random() * 900 + 100); // 3 dígitos
    document.getElementById('idSolicitud').value = `SOL-${year}${month}${day}-${randomSuffix}`;
  };

  // --- Inicialización ---
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('fechaSolicitud').valueAsDate = new Date();
    addItemRow(); // Añadir la primera fila de artículo al cargar
    generateSolicitudID();
    document.getElementById('addItemBtn').addEventListener('click', addItemRow);
  });

  // --- Manejo del Envío del Formulario ---
  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    notify('Enviando solicitud...', true);
    submitButton.disabled = true;
    submitButton.textContent = 'Enviando...';

    if (URL_SCRIPT === 'YOUR_SCRIPT_URL_HERE' || !URL_SCRIPT.startsWith('https://script.google.com/macros/s/')) {
        notify('Error CRÍTICO: La URL del script no está configurada en el HTML. Por favor, edita el archivo y reemplaza "YOUR_SCRIPT_URL_HERE".', false);
        submitButton.disabled = false;
        submitButton.textContent = 'Enviar Solicitud a Google Sheets';
        return;
    }
    
    // Recopilar datos del formulario
    const formData = new FormData(form);
    const data = {
        timestamp: new Date().toISOString(),
        idSolicitud:       formData.get('idSolicitud'),
        fechaSolicitud:    formData.get('fechaSolicitud'),
        jefeEquipo:        formData.get('jefeEquipo'),
        departamento:      formData.get('departamento'),
        centroCosto:       formData.get('centroCosto'),
        emailSolicitante:  formData.get('emailSolicitante'),
        justificacion:     formData.get('justificacion'),
        nombreJefeAprueba: formData.get('nombreJefeAprueba'),
        fechaAprobacion:   formData.get('fechaAprobacion'),
        estadoSolicitud:   formData.get('estadoSolicitud'),
        responsableEntrega:formData.get('responsableEntrega'),
        observaciones:     formData.get('observaciones'),
        items: []
    };

    // Recopilar artículos de la tabla
    const itemRows = tbodyItems.querySelectorAll('.item-row');
    itemRows.forEach(row => {
        const descripcion = row.querySelector('input[name="itemDescripcion"]').value;
        const cantidad = row.querySelector('input[name="itemCantidad"]').value;
        const unidad = row.querySelector('select[name="itemUnidad"]').value;
        if (descripcion && cantidad && unidad) { // Solo añadir si los campos principales del item están llenos
            data.items.push({ descripcion, cantidad, unidad });
        }
    });
    data.itemsJSON = JSON.stringify(data.items); // Convertir array de items a string JSON

    console.log("Datos a enviar:", JSON.stringify(data, null, 2));

    try {
      const response = await fetch(URL_SCRIPT, {
        method: 'POST',
        mode: 'cors', // Esencial para peticiones cross-origin
        headers: {
          'Content-Type': 'application/json', // Indicar que el cuerpo es JSON
        },
        body: JSON.stringify(data) // Enviar el objeto data como un string JSON
      });

      const responseText = await response.text(); // Leer siempre como texto primero
      console.log("Respuesta del servidor (texto):", responseText);

      if (!response.ok) { // Si el status no es 2xx
        // Intentar parsear como JSON si es posible para obtener mensaje de error del script
        let errorMessage = responseText;
        try {
            const errorJson = JSON.parse(responseText);
            if (errorJson && errorJson.message) {
                errorMessage = errorJson.message;
            }
        } catch (parseError) {
            // No era JSON, usar el texto de respuesta directamente
        }
        throw new Error(`Error del servidor (${response.status}): ${errorMessage}`);
      }

      const resultJson = JSON.parse(responseText); // Parsear como JSON ya que response.ok
      if (resultJson.status === 'success') {
        notify('✔ ¡Solicitud registrada correctamente en Google Sheets!', true);
        form.reset(); // Limpiar el formulario
        tbodyItems.innerHTML = ''; // Limpiar tabla de items
        addItemRow(); // Añadir una fila vacía
        generateSolicitudID(); // Generar nuevo ID
        document.getElementById('fechaSolicitud').valueAsDate = new Date(); // Resetear fecha
      } else {
        throw new Error(resultJson.message || 'Error desconocido desde el script de Google.');
      }
    } catch (error) {
      console.error('Error durante el fetch o procesamiento:', error);
      notify(`Error al enviar: ${error.message}. Revisa la consola (F12) para más detalles y verifica la URL del script y la configuración de implementación en Google Apps Script (debe permitir acceso a "Cualquier usuario").`, false);
    } finally {
      submitButton.disabled = false;
      submitButton.textContent = 'Enviar Solicitud a Google Sheets';
    }
  });
</script>
</body>
</html>
